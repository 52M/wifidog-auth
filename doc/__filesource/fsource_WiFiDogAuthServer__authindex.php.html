<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
		<head>
			<!-- template designed by Marco Von Ballmoos -->
			<title>File Source for index.php</title>
			<link rel="stylesheet" href="../media/stylesheet.css" />
			<meta http-equiv='Content-Type' content='text/html; charset=iso-8859-1'/>
		</head>
		<body>
						
<h1>Source for file index.php</h1>
<p>Documentation is available at <a href="../WiFiDogAuthServer/_wifidog_auth_index_php.html">index.php</a></p>
<div class="src-code">
<pre><ol><li><a name="a1"></a><span class="src-php">&lt;?php</span></li>
<li><a name="a2"></a>&nbsp;</li>
<li><a name="a4"></a><span class="src-comm">/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */</span></li>
<li><a name="a5"></a><span class="src-comm">// +-------------------------------------------------------------------+</span></li>
<li><a name="a6"></a><span class="src-comm">// | WiFiDog Authentication Server                                     |</span></li>
<li><a name="a7"></a><span class="src-comm">// | =============================                                     |</span></li>
<li><a name="a8"></a><span class="src-comm">// |                                                                   |</span></li>
<li><a name="a9"></a><span class="src-comm">// | The WiFiDog Authentication Server is part of the WiFiDog captive  |</span></li>
<li><a name="a10"></a><span class="src-comm">// | portal suite.                                                     |</span></li>
<li><a name="a11"></a><span class="src-comm">// +-------------------------------------------------------------------+</span></li>
<li><a name="a12"></a><span class="src-comm">// | PHP version 5 required.                                           |</span></li>
<li><a name="a13"></a><span class="src-comm">// +-------------------------------------------------------------------+</span></li>
<li><a name="a14"></a><span class="src-comm">// | Homepage:     http://www.wifidog.org/                             |</span></li>
<li><a name="a15"></a><span class="src-comm">// | Source Forge: http://sourceforge.net/projects/wifidog/            |</span></li>
<li><a name="a16"></a><span class="src-comm">// +-------------------------------------------------------------------+</span></li>
<li><a name="a17"></a><span class="src-comm">// | This program is free software; you can redistribute it and/or     |</span></li>
<li><a name="a18"></a><span class="src-comm">// | modify it under the terms of the GNU General Public License as    |</span></li>
<li><a name="a19"></a><span class="src-comm">// | published by the Free Software Foundation; either version 2 of    |</span></li>
<li><a name="a20"></a><span class="src-comm">// | the License, or (at your option) any later version.               |</span></li>
<li><a name="a21"></a><span class="src-comm">// |                                                                   |</span></li>
<li><a name="a22"></a><span class="src-comm">// | This program is distributed in the hope that it will be useful,   |</span></li>
<li><a name="a23"></a><span class="src-comm">// | but WITHOUT ANY WARRANTY; without even the implied warranty of    |</span></li>
<li><a name="a24"></a><span class="src-comm">// | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the     |</span></li>
<li><a name="a25"></a><span class="src-comm">// | GNU General Public License for more details.                      |</span></li>
<li><a name="a26"></a><span class="src-comm">// |                                                                   |</span></li>
<li><a name="a27"></a><span class="src-comm">// | You should have received a copy of the GNU General Public License |</span></li>
<li><a name="a28"></a><span class="src-comm">// | along with this program; if not, contact:                         |</span></li>
<li><a name="a29"></a><span class="src-comm">// |                                                                   |</span></li>
<li><a name="a30"></a><span class="src-comm">// | Free Software Foundation           Voice:  +1-617-542-5942        |</span></li>
<li><a name="a31"></a><span class="src-comm">// | 59 Temple Place - Suite 330        Fax:    +1-617-542-2652        |</span></li>
<li><a name="a32"></a><span class="src-comm">// | Boston, MA  02111-1307,  USA       gnu@gnu.org                    |</span></li>
<li><a name="a33"></a><span class="src-comm">// |                                                                   |</span></li>
<li><a name="a34"></a><span class="src-comm">// +-------------------------------------------------------------------+</span></li>
<li><a name="a35"></a>&nbsp;</li>
<li><a name="a36"></a><span class="src-doc">/**</span></li>
<li><a name="a37"></a><span class="src-doc"> * This is the main auth handler, be very carefull while editing this file!</span></li>
<li><a name="a38"></a><span class="src-doc"> *</span></li>
<li><a name="a39"></a><span class="src-doc"> * </span><span class="src-doc-coretag">@package</span><span class="src-doc">    WiFiDogAuthServer</span></li>
<li><a name="a40"></a><span class="src-doc"> * </span><span class="src-doc-coretag">@author</span><span class="src-doc">     Benoit Gregoire &lt;bock@step.polymtl.ca&gt;</span></li>
<li><a name="a41"></a><span class="src-doc"> * </span><span class="src-doc-coretag">@author</span><span class="src-doc">     Philippe April</span></li>
<li><a name="a42"></a><span class="src-doc"> * </span><span class="src-doc-coretag">@copyright</span><span class="src-doc">  2004-2005 Benoit Gregoire &lt;bock@step.polymtl.ca&gt; - Technologies Coeus</span></li>
<li><a name="a43"></a><span class="src-doc"> *  inc.</span></li>
<li><a name="a44"></a><span class="src-doc"> * </span><span class="src-doc-coretag">@copyright</span><span class="src-doc">  2004-2005 Philippe April</span></li>
<li><a name="a45"></a><span class="src-doc"> * </span><span class="src-doc-coretag">@version</span><span class="src-doc">    CVS: $Id: index.php,v 1.14 2005/12/26 10:40:01 max-horvath Exp $</span></li>
<li><a name="a46"></a><span class="src-doc"> * </span><span class="src-doc-coretag">@link</span><span class="src-doc">       http://sourceforge.net/projects/wifidog/</span></li>
<li><a name="a47"></a><span class="src-doc"> */</span></li>
<li><a name="a48"></a>&nbsp;</li>
<li><a name="a49"></a><span class="src-doc">/**</span></li>
<li><a name="a50"></a><span class="src-doc"> * </span><span class="src-doc-coretag">@ignore</span></li>
<li><a name="a51"></a><span class="src-doc"> */</span></li>
<li><a name="a52"></a><a href="http://www.php.net/define">define</a><span class="src-sym">(</span><span class="src-str">'BASEPATH'</span><span class="src-sym">, </span><span class="src-str">'../'</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a53"></a>&nbsp;</li>
<li><a name="a54"></a><span class="src-inc">require_once </span><span class="src-id">BASEPATH</span>.<span class="src-str">'include/common.php'</span><span class="src-sym">;</span></li>
<li><a name="a55"></a><span class="src-inc">require_once </span><span class="src-id">BASEPATH</span>.<span class="src-str">'classes/Network.php'</span><span class="src-sym">;</span></li>
<li><a name="a56"></a>&nbsp;</li>
<li><a name="a57"></a><span class="src-var">$auth_response </span>= <span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineACCOUNT_STATUS_DENIED">ACCOUNT_STATUS_DENIED</a></span><span class="src-sym">;</span></li>
<li><a name="a58"></a><span class="src-var">$auth_message </span>= <span class="src-str">''</span><span class="src-sym">;</span></li>
<li><a name="a59"></a>&nbsp;</li>
<li><a name="a60"></a><span class="src-var">$token </span>= <span class="src-id">null</span><span class="src-sym">;</span></li>
<li><a name="a61"></a><span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-key">empty </span><span class="src-sym">(</span><span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">'token'</span><span class="src-sym">]</span><span class="src-sym">))</span></li>
<li><a name="a62"></a><span class="src-sym">{</span></li>
<li><a name="a63"></a>    <span class="src-var">$token </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">EscapeString</span><span class="src-sym">(</span><span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">'token'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a64"></a><span class="src-sym">}</span></li>
<li><a name="a65"></a>&nbsp;</li>
<li><a name="a66"></a><span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">ExecSqlUniqueRes</span><span class="src-sym">(</span><span class="src-str">&quot;</span><span class="src-id">SELECT NOW</span>(), *, <span class="src-id">CASE WHEN</span> ((<span class="src-id">NOW</span>() - <span class="src-id">reg_date</span>) &gt; <span class="src-id">networks</span>.<span class="src-id">validation_grace_time</span>) <span class="src-id">THEN true ELSE false END AS validation_grace_time_expired FROM connections JOIN users ON</span> (<span class="src-id">users</span>.<span class="src-id">user_id</span>=<span class="src-id">connections</span>.<span class="src-id">user_id</span>) <span class="src-id">JOIN networks ON</span> (<span class="src-id">users</span>.<span class="src-id">account_origin</span> = <span class="src-id">networks</span>.<span class="src-id">network_id</span>) <span class="src-id">WHERE connections</span>.<span class="src-id">token</span>='<span class="src-var">$token</span>'<span class="src-str">&quot;</span><span class="src-sym">, </span><span class="src-var">$info</span><span class="src-sym">, </span><span class="src-id">false</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a67"></a><span class="src-key">if </span><span class="src-sym">(</span><span class="src-var">$info </span>!= <span class="src-id">null</span><span class="src-sym">)</span></li>
<li><a name="a68"></a><span class="src-sym">{</span></li>
<li><a name="a69"></a>    <span class="src-comm">// Retrieve the associated authenticator</span></li>
<li><a name="a70"></a>        <span class="src-var">$network </span>= <span class="src-id"><a href="../WiFiDogAuthServer/Network.html">Network</a> </span><span class="src-sym">:: </span><a href="../WiFiDogAuthServer/Network.html#methodgetObject">getObject</a><span class="src-sym">(</span><span class="src-var">$info</span><span class="src-sym">[</span><span class="src-str">'account_origin'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a71"></a>    <span class="src-var">$authenticator </span>= <span class="src-var">$network</span><span class="src-sym">-&gt;</span><span class="src-id">getAuthenticator</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a72"></a>    <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-var">$authenticator</span><span class="src-sym">)</span></li>
<li><a name="a73"></a>    <span class="src-sym">{</span></li>
<li><a name="a74"></a>        <span class="src-var">$auth_message </span>.= <span class="src-str">&quot;| Error: Unable to instanciate authenticator. &quot;</span><span class="src-sym">;</span></li>
<li><a name="a75"></a>        <span class="src-var">$auth_response </span>= <span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineACCOUNT_STATUS_ERROR">ACCOUNT_STATUS_ERROR</a></span><span class="src-sym">;</span></li>
<li><a name="a76"></a>    <span class="src-sym">}</span></li>
<li><a name="a77"></a>    <span class="src-key">else</span></li>
<li><a name="a78"></a>    <span class="src-sym">{</span></li>
<li><a name="a79"></a>        <span class="src-key">if </span><span class="src-sym">(</span><span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">'stage'</span><span class="src-sym">] </span>== <span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineSTAGE_LOGIN">STAGE_LOGIN</a></span><span class="src-sym">)</span></li>
<li><a name="a80"></a>        <span class="src-sym">{</span></li>
<li><a name="a81"></a>            <span class="src-key">if </span><span class="src-sym">(</span><span class="src-var">$info</span><span class="src-sym">[</span><span class="src-str">'token_status'</span><span class="src-sym">] </span>== <span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineTOKEN_UNUSED">TOKEN_UNUSED</a></span><span class="src-sym">)</span></li>
<li><a name="a82"></a>            <span class="src-sym">{</span></li>
<li><a name="a83"></a>                <span class="src-comm">/* This is for the 15 minutes validation period, the exact same code is also present in when the stage is counters.  If you update this one don't forget to update the other one! */</span></li>
<li><a name="a84"></a>                <span class="src-key">if </span><span class="src-sym">((</span><span class="src-var">$info</span><span class="src-sym">[</span><span class="src-str">'account_status'</span><span class="src-sym">] </span>== <span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineACCOUNT_STATUS_VALIDATION">ACCOUNT_STATUS_VALIDATION</a></span><span class="src-sym">) </span>&amp;&amp; <span class="src-sym">(</span><span class="src-var">$info</span><span class="src-sym">[</span><span class="src-str">'validation_grace_time_expired'</span><span class="src-sym">] </span>== <span class="src-str">'t'</span><span class="src-sym">))</span></li>
<li><a name="a85"></a>                <span class="src-sym">{</span></li>
<li><a name="a86"></a>                    <span class="src-var">$auth_response </span>= <span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineACCOUNT_STATUS_VALIDATION_FAILED">ACCOUNT_STATUS_VALIDATION_FAILED</a></span><span class="src-sym">;</span></li>
<li><a name="a87"></a>                    <span class="src-var">$auth_message </span>.= <span class="src-str">&quot;| The validation grace period which began at &quot;</span>.<span class="src-var">$info</span><span class="src-sym">[</span><span class="src-str">'reg_date'</span><span class="src-sym">]</span>.<span class="src-str">&quot; has now expired. &quot;</span><span class="src-sym">;</span></li>
<li><a name="a88"></a>                <span class="src-sym">}</span></li>
<li><a name="a89"></a>                <span class="src-key">else</span></li>
<li><a name="a90"></a>                <span class="src-sym">{</span></li>
<li><a name="a91"></a>                    <span class="src-comm">// Start accounting</span></li>
<li><a name="a92"></a>                                        <span class="src-key">if </span><span class="src-sym">(</span><span class="src-var">$authenticator</span><span class="src-sym">-&gt;</span><span class="src-id">acctStart</span><span class="src-sym">(</span><span class="src-var">$info</span><span class="src-sym">[</span><span class="src-str">'conn_id'</span><span class="src-sym">]</span><span class="src-sym">, </span><span class="src-var">$auth_message</span><span class="src-sym">))</span></li>
<li><a name="a93"></a>                        <span class="src-var">$auth_response </span>= <span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineACCOUNT_STATUS_ALLOWED">ACCOUNT_STATUS_ALLOWED</a></span><span class="src-sym">;</span></li>
<li><a name="a94"></a>                    <span class="src-key">else</span></li>
<li><a name="a95"></a>                        <span class="src-var">$auth_response </span>= <span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineACCOUNT_STATUS_DENIED">ACCOUNT_STATUS_DENIED</a></span><span class="src-sym">;</span></li>
<li><a name="a96"></a>&nbsp;</li>
<li><a name="a97"></a>                <span class="src-sym">}</span></li>
<li><a name="a98"></a>            <span class="src-sym">}</span></li>
<li><a name="a99"></a>            <span class="src-key">else</span></li>
<li><a name="a100"></a>                <span class="src-key">if </span><span class="src-sym">(</span><span class="src-var">$info</span><span class="src-sym">[</span><span class="src-str">'token_status'</span><span class="src-sym">] </span>== <span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineTOKEN_INUSE">TOKEN_INUSE</a> </span>&amp;&amp; <span class="src-var">$info</span><span class="src-sym">[</span><span class="src-str">'gw_id'</span><span class="src-sym">] </span>== <span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">'gw_id'</span><span class="src-sym">] </span>&amp;&amp; <span class="src-var">$info</span><span class="src-sym">[</span><span class="src-str">'mac'</span><span class="src-sym">] </span>== <span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">'mac'</span><span class="src-sym">] </span>&amp;&amp; <span class="src-var">$info</span><span class="src-sym">[</span><span class="src-str">'ip'</span><span class="src-sym">] </span>== <span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">'ip'</span><span class="src-sym">]</span><span class="src-sym">)</span></li>
<li><a name="a101"></a>                <span class="src-sym">{</span></li>
<li><a name="a102"></a>                    <span class="src-comm">// This solves the bug where the user clicks twice before getting the portal page</span></li>
<li><a name="a103"></a>                                        <span class="src-var">$auth_response </span>= <span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineACCOUNT_STATUS_ALLOWED">ACCOUNT_STATUS_ALLOWED</a></span><span class="src-sym">;</span></li>
<li><a name="a104"></a>                <span class="src-sym">}</span></li>
<li><a name="a105"></a>                <span class="src-key">else</span></li>
<li><a name="a106"></a>                <span class="src-sym">{</span></li>
<li><a name="a107"></a>                    <span class="src-var">$auth_message </span>.= <span class="src-str">&quot;| Tried to login with a token that wasn't TOKEN_UNUSED. &quot;</span><span class="src-sym">;</span></li>
<li><a name="a108"></a>                <span class="src-sym">}</span></li>
<li><a name="a109"></a>        <span class="src-sym">}</span></li>
<li><a name="a110"></a>        <span class="src-key">else</span></li>
<li><a name="a111"></a>            <span class="src-key">if </span><span class="src-sym">(</span><span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">'stage'</span><span class="src-sym">] </span>== <span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineSTAGE_LOGOUT">STAGE_LOGOUT</a> </span>|| <span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">'stage'</span><span class="src-sym">] </span>== <span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineSTAGE_COUNTERS">STAGE_COUNTERS</a></span><span class="src-sym">)</span></li>
<li><a name="a112"></a>            <span class="src-sym">{</span></li>
<li><a name="a113"></a>                <span class="src-key">if </span><span class="src-sym">(</span><span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">'stage'</span><span class="src-sym">] </span>== <span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineSTAGE_LOGOUT">STAGE_LOGOUT</a></span><span class="src-sym">)</span></li>
<li><a name="a114"></a>                <span class="src-sym">{</span></li>
<li><a name="a115"></a>                    <span class="src-var">$authenticator</span><span class="src-sym">-&gt;</span><span class="src-id">logout</span><span class="src-sym">(</span><span class="src-var">$info</span><span class="src-sym">[</span><span class="src-str">'conn_id'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a116"></a>                    <span class="src-var">$auth_message </span>.= <span class="src-str">&quot;| User is now logged out. &quot;</span><span class="src-sym">;</span></li>
<li><a name="a117"></a>                <span class="src-sym">}</span></li>
<li><a name="a118"></a>&nbsp;</li>
<li><a name="a119"></a>                <span class="src-key">if </span><span class="src-sym">(</span><span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">'stage'</span><span class="src-sym">] </span>== <span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineSTAGE_COUNTERS">STAGE_COUNTERS</a></span><span class="src-sym">)</span></li>
<li><a name="a120"></a>                <span class="src-sym">{</span></li>
<li><a name="a121"></a>                    <span class="src-key">if </span><span class="src-sym">(</span><span class="src-var">$info</span><span class="src-sym">[</span><span class="src-str">'token_status'</span><span class="src-sym">] </span>== <span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineTOKEN_INUSE">TOKEN_INUSE</a></span><span class="src-sym">)</span></li>
<li><a name="a122"></a>                    <span class="src-sym">{</span></li>
<li><a name="a123"></a>                        <span class="src-comm">/* This is for the 15 minutes validation period, the exact same code is also present when the stage is login.  If you update this one don't forget to update the other one! */</span></li>
<li><a name="a124"></a>                        <span class="src-key">if </span><span class="src-sym">((</span><span class="src-var">$info</span><span class="src-sym">[</span><span class="src-str">'account_status'</span><span class="src-sym">] </span>== <span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineACCOUNT_STATUS_VALIDATION">ACCOUNT_STATUS_VALIDATION</a></span><span class="src-sym">) </span>&amp;&amp; <span class="src-sym">(</span><span class="src-var">$info</span><span class="src-sym">[</span><span class="src-str">'validation_grace_time_expired'</span><span class="src-sym">] </span>== <span class="src-str">'t'</span><span class="src-sym">))</span></li>
<li><a name="a125"></a>                        <span class="src-sym">{</span></li>
<li><a name="a126"></a>                            <span class="src-var">$auth_response </span>= <span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineACCOUNT_STATUS_VALIDATION_FAILED">ACCOUNT_STATUS_VALIDATION_FAILED</a></span><span class="src-sym">;</span></li>
<li><a name="a127"></a>                            <span class="src-var">$auth_message </span>.= <span class="src-str">&quot;| The validation grace period which began at &quot;</span>.<span class="src-var">$info</span><span class="src-sym">[</span><span class="src-str">'reg_date'</span><span class="src-sym">]</span>.<span class="src-str">&quot; has now expired. &quot;</span><span class="src-sym">;</span></li>
<li><a name="a128"></a>                        <span class="src-sym">}</span></li>
<li><a name="a129"></a>                        <span class="src-key">else</span></li>
<li><a name="a130"></a>                        <span class="src-sym">{</span></li>
<li><a name="a131"></a>                            <span class="src-var">$auth_response </span>= <span class="src-var">$info</span><span class="src-sym">[</span><span class="src-str">'account_status'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a132"></a>                        <span class="src-sym">}</span></li>
<li><a name="a133"></a>                    <span class="src-sym">}</span></li>
<li><a name="a134"></a>&nbsp;</li>
<li><a name="a135"></a>                <span class="src-sym">}</span></li>
<li><a name="a136"></a>&nbsp;</li>
<li><a name="a137"></a>                <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-key">empty </span><span class="src-sym">(</span><span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">'incoming'</span><span class="src-sym">]</span><span class="src-sym">) </span>|| <span class="src-sym">!</span><span class="src-key">empty </span><span class="src-sym">(</span><span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">'outgoing'</span><span class="src-sym">]</span><span class="src-sym">))</span></li>
<li><a name="a138"></a>                <span class="src-sym">{</span></li>
<li><a name="a139"></a>                    <span class="src-var">$incoming </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">EscapeString</span><span class="src-sym">(</span><span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">'incoming'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a140"></a>                    <span class="src-var">$outgoing </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">EscapeString</span><span class="src-sym">(</span><span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">'outgoing'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a141"></a>&nbsp;</li>
<li><a name="a142"></a>                    <span class="src-key">if </span><span class="src-sym">((</span><span class="src-var">$incoming </span>&gt;= <span class="src-var">$info</span><span class="src-sym">[</span><span class="src-str">'incoming'</span><span class="src-sym">]</span><span class="src-sym">) </span>&amp;&amp; <span class="src-sym">(</span><span class="src-var">$outgoing </span>&gt;= <span class="src-var">$info</span><span class="src-sym">[</span><span class="src-str">'outgoing'</span><span class="src-sym">]</span><span class="src-sym">))</span></li>
<li><a name="a143"></a>                    <span class="src-sym">{</span></li>
<li><a name="a144"></a>                        <span class="src-var">$authenticator</span><span class="src-sym">-&gt;</span><span class="src-id">acctUpdate</span><span class="src-sym">(</span><span class="src-var">$info</span><span class="src-sym">[</span><span class="src-str">'conn_id'</span><span class="src-sym">]</span><span class="src-sym">, </span><span class="src-var">$incoming</span><span class="src-sym">, </span><span class="src-var">$outgoing</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a145"></a>                        <span class="src-var">$auth_message </span>.= <span class="src-str">&quot;| Updated counters. &quot;</span><span class="src-sym">;</span></li>
<li><a name="a146"></a>                    <span class="src-sym">}</span></li>
<li><a name="a147"></a>                    <span class="src-key">else</span></li>
<li><a name="a148"></a>                    <span class="src-sym">{</span></li>
<li><a name="a149"></a>                        <span class="src-var">$auth_message </span>.= <span class="src-str">&quot;| Warning:  Incoming or outgoing counter is smaller than what is stored in the database; counters not updated. &quot;</span><span class="src-sym">;</span></li>
<li><a name="a150"></a>&nbsp;</li>
<li><a name="a151"></a>                    <span class="src-sym">}</span></li>
<li><a name="a152"></a>                <span class="src-sym">}</span></li>
<li><a name="a153"></a>                <span class="src-key">else</span></li>
<li><a name="a154"></a>                <span class="src-sym">{</span></li>
<li><a name="a155"></a>                    <span class="src-var">$auth_message </span>.= <span class="src-str">&quot;| Incoming or outgoing counter is missing; counters not updated. &quot;</span><span class="src-sym">;</span></li>
<li><a name="a156"></a>                <span class="src-sym">}</span></li>
<li><a name="a157"></a>            <span class="src-sym">}</span></li>
<li><a name="a158"></a>            <span class="src-key">else</span></li>
<li><a name="a159"></a>            <span class="src-sym">{</span></li>
<li><a name="a160"></a>                <span class="src-var">$auth_message </span>.= <span class="src-str">&quot;| Error: Unknown stage. &quot;</span><span class="src-sym">;</span></li>
<li><a name="a161"></a>                <span class="src-var">$auth_response </span>= <span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineACCOUNT_STATUS_ERROR">ACCOUNT_STATUS_ERROR</a></span><span class="src-sym">;</span></li>
<li><a name="a162"></a>            <span class="src-sym">}</span></li>
<li><a name="a163"></a>    <span class="src-sym">}</span></li>
<li><a name="a164"></a><span class="src-sym">}</span></li>
<li><a name="a165"></a><span class="src-key">else</span></li>
<li><a name="a166"></a><span class="src-sym">{</span></li>
<li><a name="a167"></a>    <span class="src-var">$auth_message </span>.= <span class="src-str">&quot;| Error: couldn't find the requested token. &quot;</span><span class="src-sym">;</span></li>
<li><a name="a168"></a>    <span class="src-var">$auth_response </span>= <span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineACCOUNT_STATUS_ERROR">ACCOUNT_STATUS_ERROR</a></span><span class="src-sym">;</span></li>
<li><a name="a169"></a><span class="src-sym">}</span></li>
<li><a name="a170"></a>&nbsp;</li>
<li><a name="a171"></a>echo <span class="src-str">&quot;</span><span class="src-id">Auth</span>: <span class="src-var">$auth_response</span>\n<span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a172"></a>echo <span class="src-str">&quot;</span><span class="src-id">Messages</span>: <span class="src-var">$auth_message</span>\n<span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a173"></a>&nbsp;</li>
<li><a name="a174"></a><span class="src-comm">/*</span></li>
<li><a name="a175"></a><span class="src-comm"> * Local variables:</span></li>
<li><a name="a176"></a><span class="src-comm"> * tab-width: 4</span></li>
<li><a name="a177"></a><span class="src-comm"> * c-basic-offset: 4</span></li>
<li><a name="a178"></a><span class="src-comm"> * c-hanging-comment-ender-p: nil</span></li>
<li><a name="a179"></a><span class="src-comm"> * End:</span></li>
<li><a name="a180"></a><span class="src-comm"> */</span></li>
<li><a name="a181"></a>&nbsp;</li>
<li><a name="a182"></a><span class="src-php">?&gt;</span></li>
</ol></pre>
</div>
	<p class="notes" id="credit">
		Documentation generated on Mon, 26 Dec 2005 19:16:31 +0100 by <a href="http://www.phpdoc.org" target="_blank">phpDocumentor 1.3.0RC5</a>
	</p>
	</body>
</html>
