<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
		<head>
			<!-- template designed by Marco Von Ballmoos -->
			<title>File Source for signup.php</title>
			<link rel="stylesheet" href="../media/stylesheet.css" />
			<meta http-equiv='Content-Type' content='text/html; charset=iso-8859-1'/>
		</head>
		<body>
						
<h1>Source for file signup.php</h1>
<p>Documentation is available at <a href="../WiFiDogAuthServer/_wifidog_signup_php.html">signup.php</a></p>
<div class="src-code">
<pre><ol><li><a name="a1"></a><span class="src-php">&lt;?php</span></li>
<li><a name="a2"></a>&nbsp;</li>
<li><a name="a4"></a><span class="src-comm">/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */</span></li>
<li><a name="a5"></a><span class="src-comm">// +-------------------------------------------------------------------+</span></li>
<li><a name="a6"></a><span class="src-comm">// | WiFiDog Authentication Server                                     |</span></li>
<li><a name="a7"></a><span class="src-comm">// | =============================                                     |</span></li>
<li><a name="a8"></a><span class="src-comm">// |                                                                   |</span></li>
<li><a name="a9"></a><span class="src-comm">// | The WiFiDog Authentication Server is part of the WiFiDog captive  |</span></li>
<li><a name="a10"></a><span class="src-comm">// | portal suite.                                                     |</span></li>
<li><a name="a11"></a><span class="src-comm">// +-------------------------------------------------------------------+</span></li>
<li><a name="a12"></a><span class="src-comm">// | PHP version 5 required.                                           |</span></li>
<li><a name="a13"></a><span class="src-comm">// +-------------------------------------------------------------------+</span></li>
<li><a name="a14"></a><span class="src-comm">// | Homepage:     http://www.wifidog.org/                             |</span></li>
<li><a name="a15"></a><span class="src-comm">// | Source Forge: http://sourceforge.net/projects/wifidog/            |</span></li>
<li><a name="a16"></a><span class="src-comm">// +-------------------------------------------------------------------+</span></li>
<li><a name="a17"></a><span class="src-comm">// | This program is free software; you can redistribute it and/or     |</span></li>
<li><a name="a18"></a><span class="src-comm">// | modify it under the terms of the GNU General Public License as    |</span></li>
<li><a name="a19"></a><span class="src-comm">// | published by the Free Software Foundation; either version 2 of    |</span></li>
<li><a name="a20"></a><span class="src-comm">// | the License, or (at your option) any later version.               |</span></li>
<li><a name="a21"></a><span class="src-comm">// |                                                                   |</span></li>
<li><a name="a22"></a><span class="src-comm">// | This program is distributed in the hope that it will be useful,   |</span></li>
<li><a name="a23"></a><span class="src-comm">// | but WITHOUT ANY WARRANTY; without even the implied warranty of    |</span></li>
<li><a name="a24"></a><span class="src-comm">// | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the     |</span></li>
<li><a name="a25"></a><span class="src-comm">// | GNU General Public License for more details.                      |</span></li>
<li><a name="a26"></a><span class="src-comm">// |                                                                   |</span></li>
<li><a name="a27"></a><span class="src-comm">// | You should have received a copy of the GNU General Public License |</span></li>
<li><a name="a28"></a><span class="src-comm">// | along with this program; if not, contact:                         |</span></li>
<li><a name="a29"></a><span class="src-comm">// |                                                                   |</span></li>
<li><a name="a30"></a><span class="src-comm">// | Free Software Foundation           Voice:  +1-617-542-5942        |</span></li>
<li><a name="a31"></a><span class="src-comm">// | 59 Temple Place - Suite 330        Fax:    +1-617-542-2652        |</span></li>
<li><a name="a32"></a><span class="src-comm">// | Boston, MA  02111-1307,  USA       gnu@gnu.org                    |</span></li>
<li><a name="a33"></a><span class="src-comm">// |                                                                   |</span></li>
<li><a name="a34"></a><span class="src-comm">// +-------------------------------------------------------------------+</span></li>
<li><a name="a35"></a>&nbsp;</li>
<li><a name="a36"></a><span class="src-doc">/**</span></li>
<li><a name="a37"></a><span class="src-doc"> * Sign up page</span></li>
<li><a name="a38"></a><span class="src-doc"> *</span></li>
<li><a name="a39"></a><span class="src-doc"> * </span><span class="src-doc-coretag">@package</span><span class="src-doc">    WiFiDogAuthServer</span></li>
<li><a name="a40"></a><span class="src-doc"> * </span><span class="src-doc-coretag">@author</span><span class="src-doc">     Philippe April</span></li>
<li><a name="a41"></a><span class="src-doc"> * </span><span class="src-doc-coretag">@author</span><span class="src-doc">     Benoit Gregoire &lt;bock@step.polymtl.ca&gt;</span></li>
<li><a name="a42"></a><span class="src-doc"> * </span><span class="src-doc-coretag">@copyright</span><span class="src-doc">  2004-2005 Philippe April</span></li>
<li><a name="a43"></a><span class="src-doc"> * </span><span class="src-doc-coretag">@copyright</span><span class="src-doc">  Benoit</span></li>
<li><a name="a44"></a><span class="src-doc"> * </span><span class="src-doc-coretag">@version</span><span class="src-doc">    CVS: $Id: signup.php,v 1.17 2005/12/26 10:34:03 max-horvath Exp $</span></li>
<li><a name="a45"></a><span class="src-doc"> * </span><span class="src-doc-coretag">@link</span><span class="src-doc">       http://sourceforge.net/projects/wifidog/</span></li>
<li><a name="a46"></a><span class="src-doc"> */</span></li>
<li><a name="a47"></a>&nbsp;</li>
<li><a name="a48"></a><span class="src-doc">/**</span></li>
<li><a name="a49"></a><span class="src-doc"> * </span><span class="src-doc-coretag">@ignore</span></li>
<li><a name="a50"></a><span class="src-doc"> */</span></li>
<li><a name="a51"></a><a href="http://www.php.net/define">define</a><span class="src-sym">(</span><span class="src-str">'BASEPATH'</span><span class="src-sym">, </span><span class="src-str">'./'</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a52"></a>&nbsp;</li>
<li><a name="a53"></a><span class="src-inc">require_once </span><span class="src-id">BASEPATH</span>.<span class="src-str">'include/common.php'</span><span class="src-sym">;</span></li>
<li><a name="a54"></a><span class="src-inc">require_once </span><span class="src-id">BASEPATH</span>.<span class="src-str">'include/common_interface.php'</span><span class="src-sym">;</span></li>
<li><a name="a55"></a><span class="src-inc">require_once </span><span class="src-id">BASEPATH</span>.<span class="src-str">'classes/User.php'</span><span class="src-sym">;</span></li>
<li><a name="a56"></a><span class="src-inc">require_once </span><span class="src-id">BASEPATH</span>.<span class="src-str">'classes/Security.php'</span><span class="src-sym">;</span></li>
<li><a name="a57"></a><span class="src-inc">require_once </span><span class="src-id">BASEPATH</span>.<span class="src-str">'classes/MainUI.php'</span><span class="src-sym">;</span></li>
<li><a name="a58"></a>&nbsp;</li>
<li><a name="a59"></a><span class="src-key">if </span><span class="src-sym">(</span><a href="http://www.php.net/defined">defined</a><span class="src-sym">(</span><span class="src-str">&quot;CUSTOM_SIGNUP_URL&quot;</span><span class="src-sym">))</span></li>
<li><a name="a60"></a><span class="src-sym">{</span></li>
<li><a name="a61"></a>    <a href="http://www.php.net/header">header</a><span class="src-sym">(</span><span class="src-str">&quot;Location: &quot;</span>.<span class="src-id">CUSTOM_SIGNUP_URL</span>.<span class="src-str">&quot;?gw=&quot;</span>.<a href="http://www.php.net/base64_encode">base64_encode</a><span class="src-sym">(</span><span class="src-var">$_SERVER</span><span class="src-sym">[</span><span class="src-str">'REQUEST_URI'</span><span class="src-sym">]</span><span class="src-sym">))</span><span class="src-sym">;</span></li>
<li><a name="a62"></a>    <span class="src-key">exit</span><span class="src-sym">;</span></li>
<li><a name="a63"></a><span class="src-sym">}</span></li>
<li><a name="a64"></a>&nbsp;</li>
<li><a name="a65"></a><span class="src-key">function </span><a href="../WiFiDogAuthServer/_wifidog_signup_php.html#functionvalidate_username">validate_username</a><span class="src-sym">(</span><span class="src-var">$username</span><span class="src-sym">)</span></li>
<li><a name="a66"></a><span class="src-sym">{</span></li>
<li><a name="a67"></a>    <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span>isset <span class="src-sym">(</span><span class="src-var">$username</span><span class="src-sym">) </span>|| <span class="src-sym">!</span><span class="src-var">$username</span><span class="src-sym">)</span></li>
<li><a name="a68"></a>        throw <span class="src-key">new </span><span class="src-id">Exception</span><span class="src-sym">(</span><a href="../WiFiDogAuthServer/_wifidog_classes_Locale_php.html#function_">_</a><span class="src-sym">(</span><span class="src-str">'Username is required.'</span><span class="src-sym">))</span><span class="src-sym">;</span></li>
<li><a name="a69"></a>&nbsp;</li>
<li><a name="a70"></a>    <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span><a href="http://www.php.net/ereg">ereg</a><span class="src-sym">(</span><span class="src-str">&quot;</span><span class="src-str">^<span class="src-sym">[</span>0-9<span class="src-id">a</span>-<span class="src-id">zA</span>-<span class="src-id">Z_</span><span class="src-sym">]</span>*$</span><span class="src-str">&quot;</span><span class="src-sym">, </span><span class="src-var">$username</span><span class="src-sym">))</span></li>
<li><a name="a71"></a>        throw <span class="src-key">new </span><span class="src-id">Exception</span><span class="src-sym">(</span><a href="../WiFiDogAuthServer/_wifidog_classes_Locale_php.html#function_">_</a><span class="src-sym">(</span><span class="src-str">'Username contains invalid characters.'</span><span class="src-sym">))</span><span class="src-sym">;</span></li>
<li><a name="a72"></a><span class="src-sym">}</span></li>
<li><a name="a73"></a>&nbsp;</li>
<li><a name="a74"></a><span class="src-key">function </span><a href="../WiFiDogAuthServer/_wifidog_signup_php.html#functionvalidate_email">validate_email</a><span class="src-sym">(</span><span class="src-var">$email</span><span class="src-sym">)</span></li>
<li><a name="a75"></a><span class="src-sym">{</span></li>
<li><a name="a76"></a>    <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span>isset <span class="src-sym">(</span><span class="src-var">$email</span><span class="src-sym">) </span>|| <span class="src-sym">!</span><span class="src-var">$email</span><span class="src-sym">)</span></li>
<li><a name="a77"></a>        throw <span class="src-key">new </span><span class="src-id">Exception</span><span class="src-sym">(</span><a href="../WiFiDogAuthServer/_wifidog_classes_Locale_php.html#function_">_</a><span class="src-sym">(</span><span class="src-str">&quot;A valid email address is required.&quot;</span><span class="src-sym">))</span><span class="src-sym">;</span></li>
<li><a name="a78"></a>&nbsp;</li>
<li><a name="a79"></a>    <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span><a href="http://www.php.net/ereg">ereg</a><span class="src-sym">(</span><span class="src-str">&quot;</span><span class="src-str">^.*@.*\..*$</span><span class="src-str">&quot;</span><span class="src-sym">, </span><span class="src-var">$email</span><span class="src-sym">))</span></li>
<li><a name="a80"></a>        throw <span class="src-key">new </span><span class="src-id">Exception</span><span class="src-sym">(</span><a href="../WiFiDogAuthServer/_wifidog_classes_Locale_php.html#function_">_</a><span class="src-sym">(</span><span class="src-str">&quot;The email address must be of the form user@domain.com.&quot;</span><span class="src-sym">))</span><span class="src-sym">;</span></li>
<li><a name="a81"></a><span class="src-sym">}</span></li>
<li><a name="a82"></a>&nbsp;</li>
<li><a name="a83"></a><span class="src-key">function </span><a href="../WiFiDogAuthServer/_wifidog_signup_php.html#functionvalidate_passwords">validate_passwords</a><span class="src-sym">(</span><span class="src-var">$password</span><span class="src-sym">, </span><span class="src-var">$password_again</span><span class="src-sym">)</span></li>
<li><a name="a84"></a><span class="src-sym">{</span></li>
<li><a name="a85"></a>    <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span>isset <span class="src-sym">(</span><span class="src-var">$password</span><span class="src-sym">) </span>|| <span class="src-sym">!</span><span class="src-var">$password</span><span class="src-sym">)</span></li>
<li><a name="a86"></a>        throw <span class="src-key">new </span><span class="src-id">Exception</span><span class="src-sym">(</span><a href="../WiFiDogAuthServer/_wifidog_classes_Locale_php.html#function_">_</a><span class="src-sym">(</span><span class="src-str">&quot;A password of at least 6 characters is required.&quot;</span><span class="src-sym">))</span><span class="src-sym">;</span></li>
<li><a name="a87"></a>&nbsp;</li>
<li><a name="a88"></a>    <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span><a href="http://www.php.net/ereg">ereg</a><span class="src-sym">(</span><span class="src-str">&quot;</span><span class="src-str">^<span class="src-sym">[</span>0-9<span class="src-id">a</span>-<span class="src-id">zA</span>-<span class="src-id">Z</span><span class="src-sym">]</span>*$</span><span class="src-str">&quot;</span><span class="src-sym">, </span><span class="src-var">$password</span><span class="src-sym">))</span></li>
<li><a name="a89"></a>        throw <span class="src-key">new </span><span class="src-id">Exception</span><span class="src-sym">(</span><a href="../WiFiDogAuthServer/_wifidog_classes_Locale_php.html#function_">_</a><span class="src-sym">(</span><span class="src-str">&quot;Password contains invalid characters.&quot;</span><span class="src-sym">))</span><span class="src-sym">;</span></li>
<li><a name="a90"></a>&nbsp;</li>
<li><a name="a91"></a>    <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span>isset <span class="src-sym">(</span><span class="src-var">$password_again</span><span class="src-sym">))</span></li>
<li><a name="a92"></a>        throw <span class="src-key">new </span><span class="src-id">Exception</span><span class="src-sym">(</span><a href="../WiFiDogAuthServer/_wifidog_classes_Locale_php.html#function_">_</a><span class="src-sym">(</span><span class="src-str">&quot;You must type your password twice.&quot;</span><span class="src-sym">))</span><span class="src-sym">;</span></li>
<li><a name="a93"></a>&nbsp;</li>
<li><a name="a94"></a>    <span class="src-key">if </span><span class="src-sym">(</span><span class="src-var">$password </span>!= <span class="src-var">$password_again</span><span class="src-sym">)</span></li>
<li><a name="a95"></a>        throw <span class="src-key">new </span><span class="src-id">Exception</span><span class="src-sym">(</span><a href="../WiFiDogAuthServer/_wifidog_classes_Locale_php.html#function_">_</a><span class="src-sym">(</span><span class="src-str">&quot;Passwords do not match.&quot;</span><span class="src-sym">))</span><span class="src-sym">;</span></li>
<li><a name="a96"></a>&nbsp;</li>
<li><a name="a97"></a>    <span class="src-key">if </span><span class="src-sym">(</span><a href="http://www.php.net/strlen">strlen</a><span class="src-sym">(</span><span class="src-var">$password</span><span class="src-sym">) </span>&lt; <span class="src-num">6</span><span class="src-sym">)</span></li>
<li><a name="a98"></a>        throw <span class="src-key">new </span><span class="src-id">Exception</span><span class="src-sym">(</span><a href="../WiFiDogAuthServer/_wifidog_classes_Locale_php.html#function_">_</a><span class="src-sym">(</span><span class="src-str">&quot;Password is too short, it must be 6 characters minimum.&quot;</span><span class="src-sym">))</span><span class="src-sym">;</span></li>
<li><a name="a99"></a><span class="src-sym">}</span></li>
<li><a name="a100"></a>&nbsp;</li>
<li><a name="a101"></a><span class="src-key">if </span><span class="src-sym">(</span>isset <span class="src-sym">(</span><span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">&quot;submit&quot;</span><span class="src-sym">]</span><span class="src-sym">))</span></li>
<li><a name="a102"></a><span class="src-sym">{</span></li>
<li><a name="a103"></a>    <span class="src-var">$username </span>= <a href="http://www.php.net/trim">trim</a><span class="src-sym">(</span><span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">'username'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a104"></a>    <span class="src-var">$email </span>= <a href="http://www.php.net/trim">trim</a><span class="src-sym">(</span><span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">'email'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a105"></a>    <span class="src-var">$password </span>= <a href="http://www.php.net/trim">trim</a><span class="src-sym">(</span><span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">'password'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a106"></a>    <span class="src-var">$password_again </span>= <a href="http://www.php.net/trim">trim</a><span class="src-sym">(</span><span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">'password_again'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a107"></a>    <span class="src-var">$smarty</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'username'</span><span class="src-sym">, </span><span class="src-var">$username</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a108"></a>    <span class="src-var">$smarty</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'email'</span><span class="src-sym">, </span><span class="src-var">$email</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a109"></a>    <span class="src-var">$network </span>= <span class="src-id"><a href="../WiFiDogAuthServer/Network.html">Network</a></span><span class="src-sym">::</span><a href="../WiFiDogAuthServer/Network.html#methodgetObject">getObject</a><span class="src-sym">(</span><span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">'auth_source'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a110"></a>    try</li>
<li><a name="a111"></a>    <span class="src-sym">{</span></li>
<li><a name="a112"></a>        <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span>isset<span class="src-sym">(</span><span class="src-var">$network</span><span class="src-sym">))</span></li>
<li><a name="a113"></a>            throw <span class="src-key">new </span><span class="src-id">Exception</span><span class="src-sym">(</span><a href="../WiFiDogAuthServer/_wifidog_classes_Locale_php.html#function_">_</a><span class="src-sym">(</span><span class="src-str">&quot;Sorry, this network does not exist !&quot;</span><span class="src-sym">))</span><span class="src-sym">;</span></li>
<li><a name="a114"></a>        <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-var">$network</span><span class="src-sym">-&gt;</span><span class="src-id">getAuthenticator</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">-&gt;</span><span class="src-id">isRegistrationPermitted</span><span class="src-sym">(</span><span class="src-sym">))</span></li>
<li><a name="a115"></a>            throw <span class="src-key">new </span><span class="src-id">Exception</span><span class="src-sym">(</span><a href="../WiFiDogAuthServer/_wifidog_classes_Locale_php.html#function_">_</a><span class="src-sym">(</span><span class="src-str">&quot;Sorry, this network does not accept new user registration !&quot;</span><span class="src-sym">))</span><span class="src-sym">;</span></li>
<li><a name="a116"></a>        <a href="../WiFiDogAuthServer/_wifidog_signup_php.html#functionvalidate_username">validate_username</a><span class="src-sym">(</span><span class="src-var">$username</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a117"></a>        <a href="../WiFiDogAuthServer/_wifidog_signup_php.html#functionvalidate_email">validate_email</a><span class="src-sym">(</span><span class="src-var">$email</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a118"></a>        <a href="../WiFiDogAuthServer/_wifidog_signup_php.html#functionvalidate_passwords">validate_passwords</a><span class="src-sym">(</span><span class="src-var">$password</span><span class="src-sym">, </span><span class="src-var">$password_again</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a119"></a>&nbsp;</li>
<li><a name="a120"></a>        <span class="src-key">if </span><span class="src-sym">(</span><span class="src-id"><a href="../WiFiDogAuthServer/User.html">User</a> </span><span class="src-sym">:: </span><a href="../WiFiDogAuthServer/User.html#methodgetUserByUsernameAndOrigin">getUserByUsernameAndOrigin</a><span class="src-sym">(</span><span class="src-var">$username</span><span class="src-sym">, </span><span class="src-var">$network</span><span class="src-sym">))</span></li>
<li><a name="a121"></a>            throw <span class="src-key">new </span><span class="src-id">Exception</span><span class="src-sym">(</span><a href="../WiFiDogAuthServer/_wifidog_classes_Locale_php.html#function_">_</a><span class="src-sym">(</span><span class="src-str">&quot;Sorry, a user account is already associated to this username. Pick another one.&quot;</span><span class="src-sym">))</span><span class="src-sym">;</span></li>
<li><a name="a122"></a>&nbsp;</li>
<li><a name="a123"></a>        <span class="src-key">if </span><span class="src-sym">(</span><span class="src-id"><a href="../WiFiDogAuthServer/User.html">User</a> </span><span class="src-sym">:: </span><a href="../WiFiDogAuthServer/User.html#methodgetUserByEmailAndOrigin">getUserByEmailAndOrigin</a><span class="src-sym">(</span><span class="src-var">$email</span><span class="src-sym">, </span><span class="src-var">$network</span><span class="src-sym">))</span></li>
<li><a name="a124"></a>            throw <span class="src-key">new </span><span class="src-id">Exception</span><span class="src-sym">(</span><a href="../WiFiDogAuthServer/_wifidog_classes_Locale_php.html#function_">_</a><span class="src-sym">(</span><span class="src-str">&quot;Sorry, a user account is already associated to this email address.&quot;</span><span class="src-sym">))</span><span class="src-sym">;</span></li>
<li><a name="a125"></a>&nbsp;</li>
<li><a name="a126"></a>        <span class="src-var">$created_user </span>= <span class="src-id"><a href="../WiFiDogAuthServer/User.html">User</a> </span><span class="src-sym">:: </span><a href="../WiFiDogAuthServer/User.html#methodcreateUser">createUser</a><span class="src-sym">(</span><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#functionget_guid">get_guid</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">, </span><span class="src-var">$username</span><span class="src-sym">, </span><span class="src-var">$network</span><span class="src-sym">, </span><span class="src-var">$email</span><span class="src-sym">, </span><span class="src-var">$password</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a127"></a>        <span class="src-var">$created_user</span><span class="src-sym">-&gt;</span><span class="src-id">sendValidationEmail</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a128"></a>&nbsp;</li>
<li><a name="a129"></a>        <span class="src-comm">// If the user is at a REAL hotspot, give him his 15 minutes right away</span></li>
<li><a name="a130"></a>                <span class="src-var">$gw_id </span>= <span class="src-var">$session</span><span class="src-sym">-&gt;</span><span class="src-id">get</span><span class="src-sym">(</span><span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineSESS_GW_ID_VAR">SESS_GW_ID_VAR</a></span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a131"></a>        <span class="src-var">$gw_address </span>= <span class="src-var">$session</span><span class="src-sym">-&gt;</span><span class="src-id">get</span><span class="src-sym">(</span><span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineSESS_GW_ADDRESS_VAR">SESS_GW_ADDRESS_VAR</a></span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a132"></a>        <span class="src-var">$gw_port </span>= <span class="src-var">$session</span><span class="src-sym">-&gt;</span><span class="src-id">get</span><span class="src-sym">(</span><span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineSESS_GW_PORT_VAR">SESS_GW_PORT_VAR</a></span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a133"></a>&nbsp;</li>
<li><a name="a134"></a>        <span class="src-key">if</span><span class="src-sym">(</span><span class="src-var">$gw_id </span>&amp;&amp; <span class="src-var">$gw_address </span>&amp;&amp; <span class="src-var">$gw_port</span><span class="src-sym">)</span></li>
<li><a name="a135"></a>        <span class="src-sym">{</span></li>
<li><a name="a136"></a>            <span class="src-comm">// Authenticate this new user automatically</span></li>
<li><a name="a137"></a>                        <span class="src-var">$authenticated_user </span>= <span class="src-var">$network</span><span class="src-sym">-&gt;</span><span class="src-id">getAuthenticator</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">-&gt;</span><span class="src-id">login</span><span class="src-sym">(</span><span class="src-var">$username</span><span class="src-sym">, </span><span class="src-var">$password</span><span class="src-sym">, </span><span class="src-var">$errmsg</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a138"></a>&nbsp;</li>
<li><a name="a139"></a>            <span class="src-comm">// Make sure the user IDs match</span></li>
<li><a name="a140"></a>                        <span class="src-key">if</span><span class="src-sym">((</span><span class="src-var">$created_user</span><span class="src-sym">-&gt;</span><span class="src-id">getId</span><span class="src-sym">(</span><span class="src-sym">) </span>== <span class="src-var">$authenticated_user</span><span class="src-sym">-&gt;</span><span class="src-id">getId</span><span class="src-sym">(</span><span class="src-sym">)))</span></li>
<li><a name="a141"></a>            <span class="src-sym">{</span></li>
<li><a name="a142"></a>                <span class="src-var">$token </span>= <span class="src-var">$created_user</span><span class="src-sym">-&gt;</span><span class="src-id">generateConnectionToken</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a143"></a>                <a href="http://www.php.net/header">header</a><span class="src-sym">(</span><span class="src-str">&quot;</span><span class="src-id">Location</span>: <span class="src-id">http</span>://{<span class="src-var">$gw_address</span><span class="src-sym">}</span>:{<span class="src-var">$gw_port</span><span class="src-sym">}</span>/<span class="src-id">wifidog</span>/<span class="src-id">auth</span>?<span class="src-id">token</span>={<span class="src-var">$token</span><span class="src-sym">}</span><span class="src-str">&quot;</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a144"></a>            <span class="src-sym">}</span></li>
<li><a name="a145"></a>            <span class="src-key">else</span></li>
<li><a name="a146"></a>                <a href="http://www.php.net/header">header</a><span class="src-sym">(</span><span class="src-str">&quot;Location: &quot;</span>.<span class="src-id"><a href="../WiFiDogAuthServer/_wifidog_include_common_php.html#defineBASE_NON_SSL_PATH">BASE_NON_SSL_PATH</a></span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a147"></a>        <span class="src-sym">}</span></li>
<li><a name="a148"></a>        <span class="src-key">else</span></li>
<li><a name="a149"></a>            <span class="src-var">$smarty</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'message'</span><span class="src-sym">, </span><a href="../WiFiDogAuthServer/_wifidog_classes_Locale_php.html#function_">_</a><span class="src-sym">(</span><span class="src-str">'An email with confirmation instructions was sent to your email address.  Your account has been granted 15 minutes of access to retrieve your email and validate your account.  You may now open a browser window and go to any remote Internet address to obtain the login page.'</span><span class="src-sym">))</span><span class="src-sym">;</span></li>
<li><a name="a150"></a>&nbsp;</li>
<li><a name="a151"></a>        <span class="src-comm">//$smarty-&gt;display(&quot;templates/validate.html&quot;);</span></li>
<li><a name="a152"></a>&nbsp;</li>
<li><a name="a152"></a>        </li>
<li><a name="a153"></a>        <span class="src-var">$ui </span>= <span class="src-key">new </span><span class="src-id"><a href="../WiFiDogAuthServer/MainUI.html">MainUI</a></span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a154"></a>        <span class="src-var">$ui</span><span class="src-sym">-&gt;</span><span class="src-id">setMainContent</span><span class="src-sym">(</span><span class="src-var">$smarty</span><span class="src-sym">-&gt;</span><span class="src-id">fetch</span><span class="src-sym">(</span><span class="src-str">&quot;templates/validate.html&quot;</span><span class="src-sym">))</span><span class="src-sym">;</span></li>
<li><a name="a155"></a>        <span class="src-var">$ui</span><span class="src-sym">-&gt;</span><span class="src-id">display</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a156"></a>        <span class="src-key">exit</span><span class="src-sym">;</span></li>
<li><a name="a157"></a>    <span class="src-sym">}</span></li>
<li><a name="a158"></a>    catch <span class="src-sym">(</span><span class="src-id">Exception </span><span class="src-var">$e</span><span class="src-sym">)</span></li>
<li><a name="a159"></a>    <span class="src-sym">{</span></li>
<li><a name="a160"></a>        <span class="src-var">$smarty</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'error'</span><span class="src-sym">, </span><span class="src-var">$e</span><span class="src-sym">-&gt;</span><span class="src-id">getMessage</span><span class="src-sym">(</span><span class="src-sym">))</span><span class="src-sym">;</span></li>
<li><a name="a161"></a>    <span class="src-sym">}</span></li>
<li><a name="a162"></a><span class="src-sym">}</span></li>
<li><a name="a163"></a><span class="src-comm">// Add the auth servers list to smarty variables</span></li>
<li><a name="a164"></a><span class="src-var">$sources </span>= <span class="src-key">array </span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a165"></a><span class="src-comm">// Preserve keys</span></li>
<li><a name="a166"></a><span class="src-var">$network_array</span>=<span class="src-id"><a href="../WiFiDogAuthServer/Network.html">Network</a></span><span class="src-sym">::</span><a href="../WiFiDogAuthServer/Network.html#methodgetAllNetworks">getAllNetworks</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a167"></a><span class="src-key">foreach </span><span class="src-sym">(</span><span class="src-var">$network_array </span><span class="src-key">as </span><span class="src-var">$network</span><span class="src-sym">)</span></li>
<li><a name="a168"></a>    <span class="src-key">if </span><span class="src-sym">(</span><span class="src-var">$network</span><span class="src-sym">-&gt;</span><span class="src-id">getAuthenticator</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">-&gt;</span><span class="src-id">isRegistrationPermitted</span><span class="src-sym">(</span><span class="src-sym">))</span></li>
<li><a name="a169"></a>        <span class="src-var">$sources</span><span class="src-sym">[</span><span class="src-var">$network</span><span class="src-sym">-&gt;</span><span class="src-id">getId</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">] </span>= <span class="src-var">$network</span><span class="src-sym">-&gt;</span><span class="src-id">getName</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a170"></a>&nbsp;</li>
<li><a name="a171"></a>isset <span class="src-sym">(</span><span class="src-var">$sources</span><span class="src-sym">) </span>&amp;&amp; <span class="src-var">$smarty</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'auth_sources'</span><span class="src-sym">, </span><span class="src-var">$sources</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a172"></a><span class="src-comm">// Pass the account_origin along, if it's set</span></li>
<li><a name="a173"></a>isset <span class="src-sym">(</span><span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">&quot;auth_source&quot;</span><span class="src-sym">]</span><span class="src-sym">) </span>&amp;&amp; <span class="src-var">$smarty</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'selected_auth_source'</span><span class="src-sym">, </span><span class="src-var">$_REQUEST</span><span class="src-sym">[</span><span class="src-str">&quot;auth_source&quot;</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a174"></a>&nbsp;</li>
<li><a name="a175"></a><span class="src-var">$ui </span>= <span class="src-key">new </span><span class="src-id"><a href="../WiFiDogAuthServer/MainUI.html">MainUI</a></span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a176"></a><span class="src-var">$smarty</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'SelectNetworkUI'</span><span class="src-sym">, </span><span class="src-id"><a href="../WiFiDogAuthServer/Network.html">Network</a></span><span class="src-sym">::</span><a href="../WiFiDogAuthServer/Network.html#methodgetSelectNetworkUI">getSelectNetworkUI</a><span class="src-sym">(</span><span class="src-str">'auth_source'</span><span class="src-sym">))</span><span class="src-sym">;</span></li>
<li><a name="a177"></a><span class="src-var">$ui</span><span class="src-sym">-&gt;</span><span class="src-id">setMainContent</span><span class="src-sym">(</span><span class="src-var">$smarty</span><span class="src-sym">-&gt;</span><span class="src-id">fetch</span><span class="src-sym">(</span><span class="src-str">&quot;templates/signup.html&quot;</span><span class="src-sym">))</span><span class="src-sym">;</span></li>
<li><a name="a178"></a><span class="src-var">$ui</span><span class="src-sym">-&gt;</span><span class="src-id">display</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a179"></a>&nbsp;</li>
<li><a name="a180"></a><span class="src-comm">/*</span></li>
<li><a name="a181"></a><span class="src-comm"> * Local variables:</span></li>
<li><a name="a182"></a><span class="src-comm"> * tab-width: 4</span></li>
<li><a name="a183"></a><span class="src-comm"> * c-basic-offset: 4</span></li>
<li><a name="a184"></a><span class="src-comm"> * c-hanging-comment-ender-p: nil</span></li>
<li><a name="a185"></a><span class="src-comm"> * End:</span></li>
<li><a name="a186"></a><span class="src-comm"> */</span></li>
<li><a name="a187"></a>&nbsp;</li>
<li><a name="a188"></a><span class="src-php">?&gt;</span></li>
</ol></pre>
</div>
	<p class="notes" id="credit">
		Documentation generated on Mon, 26 Dec 2005 12:28:04 +0100 by <a href="http://www.phpdoc.org" target="_blank">phpDocumentor 1.3.0RC5</a>
	</p>
	</body>
</html>
